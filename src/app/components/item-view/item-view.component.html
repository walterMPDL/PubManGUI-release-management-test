@for(msg of errorMessages; track msg) {
<div class="alert alert-danger">
  {{msg}}
</div>
}

@if(!loading) {
@if (item) {

<pure-topnav>

  @if (item.publicState !== 'WITHDRAWN') {
  <div class="navbar-nav" start>
    @if (authorizationInfo && authorizationInfo.actions['EDIT'] && isLatestVersion) {
    <a [routerLink]="['/edit/'+ item.objectId]" class="nav-link px-2" ngbTooltip="{{'common.edit' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">edit</span>
    </a>
    }

    @if (authorizationInfo && authorizationInfo.actions['RELEASE'] && isLatestVersion) {
    <button class="nav-link" (click)="openActionsModal('release')" ngbTooltip="{{'common.release' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">public</span>
    </button>
    }

    @if (authorizationInfo && authorizationInfo.actions['SUBMIT'] && isLatestVersion) {
    <button class="nav-link" (click)="openActionsModal('submit')" ngbTooltip="{{'common.submit' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">workspace_premium</span>
    </button>
    }

    @if (authorizationInfo && authorizationInfo.actions['REVISE'] && isLatestVersion) {
    <button class="nav-link" (click)="openActionsModal('revise')" ngbTooltip="{{'common.revise' | translate}}"
      placement="bottom-left">
      <svg fill="currentColor" height="24px" width="24px">
        <use href="assets/icons/icons.svg#revise"></use>
      </svg>
    </button>
    }

    @if (authorizationInfo && authorizationInfo.actions['WITHDRAW'] && isLatestVersion) {
    <button class="nav-link" (click)="openActionsModal('withdraw')" ngbTooltip="{{'common.withdraw' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">public_off</span>
    </button>
    }

    @if (authorizationInfo && authorizationInfo.actions['DELETE'] && isLatestVersion) {
    <button class="nav-link" (click)="openActionsModal('delete')" ngbTooltip="{{'common.delete' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">delete_forever</span>
    </button>
    }

    @if (authorizationInfo && authorizationInfo.actions['ADD_NEW_DOI'] && isLatestVersion) {
    <button class="nav-link svg-icon" (click)="openActionsModal('addDoi')" ngbTooltip="{{'common.addDoi' | translate}}"
      placement="bottom-left">
      <svg fill="currentColor" height="24px" width="24px">
        <use href="assets/icons/icons.svg#doi"></use>
      </svg>
    </button>
    }

    @if(authorizationInfo && authorizationInfo.actions['EDIT'] && item.latestVersion?.versionNumber !==
    item.versionNumber) {

    <button class="nav-link" (click)="openActionsModal('rollback', item?.versionNumber)"
      ngbTooltip="{{'common.rollback' | translate}} (Version {{item?.versionNumber}})" placement="bottom-left">
      <span class="material-symbols-outlined">history</span>
    </button>
    }

    <div class="vr"></div>

    @if (aaService.principal.value.isDepositor) {
    <button class="nav-link" (click)="useAsTemplate()" ngbTooltip="{{'common.useAsTemplate' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">copy_all</span>
    </button>
    }

    <div class="vr"></div>

    <button class="nav-link" (click)="openExportModal()" ngbTooltip="{{'common.export' | translate}}"
      placement="bottom-left">
      <span class="material-symbols-outlined">upload</span>
    </button>

    <div class="vr"></div>

    <pure-topnav-cart [resetSelectionAfterAction]="false" />

    @if (aaService.principal.value.isModerator) {
      <div class="vr"></div>
      <pure-topnav-batch [resetSelectionAfterAction]="false" />
    }
  </div>
  }

  @if (listStateService.currentFullQuery && listStateService.page > 0) {
  <pure-paginator end [totalNumberOfItems]="listStateService.currentNumberOfRecords" [size]=1
    [(pageNumber)]="listStateService.page" (paginatorChanged)="listStateService.paginatorChanged()" />
  }
</pure-topnav>


<div class="row mt-5">
  @if (isModeratorOrDepositor && item.message && item.publicState !== 'WITHDRAWN') {
  <div class="alert alert-light">
    <b>{{ 'common.comment' | translate }}:</b> {{ item.message }}
  </div>
  }
  @if (item.publicState === 'WITHDRAWN') {
  <div class="alert alert-danger">
    <b>{{ 'ItemState.WITHDRAWN' | translate }} ({{ item.modificationDate | date: 'shortDate' }}):</b> {{ item.message }}
  </div>
  }


  <div class="col-lg-9 col-sm-12 p-3 bg-light rounded">

    <div class="row">
      <div class="col-2  text-center mb-3">

          @if (thumbnailUrl) {
            <a href="{{firstPublicPdfFileUrl}}" target="_blank">
              <img id="thumbnail" [src]="thumbnailUrl" class="img-thumbnail">
            </a>
          } @else {
            <img id="thumbnail" src="assets/images/DefaultMPGv2.png" class="img-thumbnail">
          }

      </div>
      <div class="col-10">
        <!-- badges -->
        <pure-item-badges [item]="item" [showVersion]="true" [showPublicStatusIcon]="true" />
        <!-- title -->
        <h3 class="mt-3" [innerHTML]="item.metadata.title | sanitizeHtml">{{ item.metadata.title }}</h3>
        <!-- alternative titles -->
        @if (firstSubtitle) {
        <h5>{{ firstSubtitle.value }}</h5>
        }
        <!-- author -->
        <div class="d-flex flex-wrap mt-2 align-content-stretch">
          @for (author of firstAuthors; track author; let i = $index) {
          <div class="me-5 mb-1">
            {{ (author?.person?.familyName || 'n/a') + ', ' + (author?.person?.givenName || 'n/a') }}
            @if (author?.person?.orcid) {
            <span class="me-2">
              <sup>
                <a [href]="author?.person?.orcid" target="_blank">
                  <img alt="ORCID logo" src="assets/images/ORCID-iD_icon_vector.svg" width="16" height="16" />
                </a>
              </sup>
            </span>
            }
            @if (author?.person?.identifier?.id) {
            <span class="me-2">
              <sup>
                <a [href]="'/cone'+author?.person?.identifier?.id" target="_blank">
                  <img alt="CoNE logo" src="assets/icons/CoNE_icon.svg" width="16" height="16" />
                </a>
              </sup>
            </span>

            }
          </div>
          }
          @if (item.metadata.creators && item.metadata.creators.length > 10) {
          <div class="me-5">
            <button type="button" class="btn btn-link p-0 align-baseline" (click)="scrollToCreators()">{{
              (item.metadata.creators.length - 10) + ' more authors ...' }}
            </button>
          </div>
          }
        </div>

        <!--citation-->
        @if (item.publicState !== 'WITHDRAWN') {
        <div class="mt-4">
          <i class="bi bi-quote me-2"></i>
          <span [innerHTML]="citation | sanitizeHtmlCitation"></span>
        </div>
        }


      </div>


      <!-- Tab navigation -->
      <div class="row mt-5" id="item-view-subnav">
        <ul class="nav nav-pills nav-fill">
          <li class="nav-item">
            <button type="button" class="nav-link {{currentSubMenuSelection === 'abstract' ? 'active' : ''}}" href="#"
              (click)="changeSubMenu('abstract')">{{ 'MetadataFields.abstract' | translate }}
            </button>
          </li>
          <li class="nav-item">
            <button type="button" class="nav-link {{currentSubMenuSelection === 'metadata' ? 'active' : ''}}"
              (click)="changeSubMenu('metadata')">{{ 'common.metadata' | translate }}
            </button>
          </li>
          <li class="nav-item">
            <button type="button" class="nav-link {{currentSubMenuSelection === 'versions' ? 'active' : ''}}" href="#"
              (click)="changeSubMenu('versions')">{{ 'common.versions' | translate }}
            </button>
          </li>
          @if (aaService.principal.value.loggedIn) {
          <li class="nav-item">
            <button type="button" class="nav-link {{currentSubMenuSelection === 'admin' ? 'active' : ''}}" href="#"
              (click)="changeSubMenu('admin')">Admin
            </button>
          </li>
          }
        </ul>
      </div>
    </div>

    <hr />
    <!-- Metadata -->
    <div class="row mt-3">

      <!--Sub content-->
      @if (currentSubMenuSelection === 'metadata') {
      @if (item.publicState !== 'WITHDRAWN') {
      <pure-item-view-metadata [item]="item" />
      } @else {
      <p class="text-danger">{{ 'ItemState.WITHDRAWN' | translate }}</p>
      }

      } @else if (currentSubMenuSelection === 'abstract') {
      @if (item.publicState !== 'WITHDRAWN') {
      @if (item.metadata.abstracts) {
      @for (abs of item.metadata.abstracts; track abs; ) {
      <pure-item-view-metadata-element>
        <span label>{{ 'MetadataFields.abstract' | translate }} {{ abs.language ? '(' + abs.language + ')' : ''
          }}</span>
        <span content [innerHTML]="abs.value | sanitizeHtml"></span>
      </pure-item-view-metadata-element>
      }
      } @else {
      <pure-item-view-metadata-element>
        <span label>{{ 'MetadataFields.abstract' | translate }}</span>
        <span content>-</span>
      </pure-item-view-metadata-element>
      }
      } @else {
      <p class="text-danger">{{ 'ItemState.WITHDRAWN' | translate }}</p>
      }

      } @else if (currentSubMenuSelection === 'versions') {

      @if (versionMap$ | async; as versionMap) {

      @for (vm of versionMap; track vm[0]; ) {
      <pure-item-view-metadata-element>
        <span label>
          @if (vm[0] !== item.versionNumber) {
          <a [routerLink]="'/view/' + vm[1][0].pubItem.objectId + '_' + vm[0]">Version {{ vm[0] }}</a>
          }
          @else {
          Version {{ vm[0] }}
          }
          @if(authorizationInfo && authorizationInfo.actions['EDIT'] && item.latestVersion?.versionNumber !== vm[0]) {
          <div class="mt-2">
            <button type="button" class="btn btn-secondary btn-sm" (click)="openActionsModal('rollback', vm[0])"><i
                class="material-symbols-outlined">history</i> {{'common.rollback'| translate}}</button>
          </div>
          }


        </span>
        <span content>
          @for (auditEntry of vm[1]; track auditEntry; let last = $last) {
          <pure-item-view-metadata-element [sub]="true">
            <span label>{{ 'MetadataFields.date' | translate }}</span>
            <span content>{{ auditEntry.modificationDate | date:'medium' }}</span>
          </pure-item-view-metadata-element>
          <pure-item-view-metadata-element [sub]="true">
            <span label>{{ 'common.actions' | translate }}</span>
            <span content>{{ auditEntry.event }}</span>
          </pure-item-view-metadata-element>
          @if (isModeratorOrDepositor) {
          <pure-item-view-metadata-element [sub]="true">
            <span label>{{ 'common.comment' | translate }}</span>
            <span content>{{ auditEntry.comment }}</span>
          </pure-item-view-metadata-element>
          }
          @if(!last) {
          <hr />
          }
          }

        </span>
      </pure-item-view-metadata-element>

      }
      } @else {
      <pure-loading />
      }
      } @else if (currentSubMenuSelection === 'admin') {
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>ID</span>
        <span content>
          {{ item.objectId + '_' + item.versionNumber }}
        </span>
      </pure-item-view-metadata-element>
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.context' | translate }}</span>
        <span content>
          {{ item.context?.name }}
          @if (authorizationInfo && authorizationInfo.actions['EDIT']) {
          <button class="btn btn-sm btn-outline-secondary" (click)="openChangeContextModal()">
            {{'common.changeContext' | translate}}
          </button>
          }
        </span>
      </pure-item-view-metadata-element>
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.dateCreated' | translate }}</span>
        <span content>
          {{ item.creationDate | date:'medium' }}
        </span>
      </pure-item-view-metadata-element>
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.creator' | translate }}</span>
        <span content>
          @if(isModeratorOrDepositor) {
          {{ (itemCreator$ | async)?.name }}
          }
          ({{item.creator?.objectId}})
        </span>
      </pure-item-view-metadata-element>
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.dateModified' | translate }}</span>
        <span content>
          {{ item.modificationDate | date:'medium' }}
        </span>
      </pure-item-view-metadata-element>
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.modifier' | translate }}</span>
        <span content>
          @if(isModeratorOrDepositor) {
          {{ (itemModifier$ | async)?.name }}
          }
          ({{item.modifier?.objectId}})
        </span>
      </pure-item-view-metadata-element>
      @if(isModeratorOrDepositor) {
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'common.comment' | translate }}</span>
        <span content>
          {{ item.message }}
        </span>
      </pure-item-view-metadata-element>
      }
      <pure-item-view-metadata-element [sub]="true" [hl]="true">
        <span label>{{ 'MetadataFields.localTags' | translate }}</span>
        <span content>
          @for(localTag of item.localTags; track localTag) {
          <span class="badge bg-secondary me-2">{{localTag}}</span>
          }
          @if (authorizationInfo && authorizationInfo.actions['EDIT']) {
          <button class="btn btn-sm btn-outline-secondary" (click)="openUpdateLocalTagsModal()">
            {{'common.updateLocalTags' | translate}}
          </button>
          }
        </span>
      </pure-item-view-metadata-element>

      }

    </div>


  </div>

  <!-- Files and references -->
  <div class="col-lg-3">

    <div class="container mt-2">
      <h5>{{ 'common.files' | translate }}</h5>
      <pure-item-view-file [files]="storedFiles" [item]="item" />
    </div>

    <div class="container mt-5">
      <h5>Links</h5>
      <pure-item-view-file [files]="externalReferences" [item]="item" />
    </div>


    <div class="container mt-5">
      <h5>{{ 'common.item' | translate }} Information</h5>
      @if (item.publicState !== 'WITHDRAWN') {

      @if ((item.latestRelease | empty) && item.versionNumber !== item.latestRelease?.versionNumber) {
      <div class="mt-3">
        <h6 class="">{{ 'common.latestRelease' | translate }}</h6>
        <div>
          <a class="icon-link fw-bold" routerLink="/view/{{item.objectId +'_' + item.latestRelease?.versionNumber}}">
            <i class="bi-link"></i>
            <span class="text-truncate">Version {{ item.latestRelease?.versionNumber }}</span>
          </a>
        </div>

      </div>
      }

      @if ((item.latestVersion | empty) && item.versionNumber !== item.latestVersion?.versionNumber &&
      latestVersionAuthorizationInfo && latestVersionAuthorizationInfo.actions['GET'] &&
      !((item.latestRelease | empty) && item.latestVersion?.versionNumber === item.latestRelease?.versionNumber)) {
      <div class="mt-3">
        <h6>{{ 'common.latestVersion' | translate }}</h6>
        <div>
          <a class="icon-link fw-bold" routerLink="/view/{{item.objectId +'_' + item.latestVersion?.versionNumber}}">
            <i class="bi-link"></i>
            <span class="text-truncate">Version {{ item.latestVersion?.versionNumber }}</span>
          </a>
        </div>

      </div>
      }

      @if (item.objectPid | empty) {
      <div class="mt-3">
        <h6>{{ 'common.item' | translate }} {{ 'common.handle' | translate }}</h6>
        <div class="row">

          <div class="col-11 text-truncate">
            <a href="https://hdl.handle.net/{{item.objectPid?.substring(4)}}">
              <i class="bi-link"></i>
              {{ item.objectPid }}
            </a>
          </div>
          <div class="col-1 p-0">
            <button class="btn btn-sm border-0 p-0" pureCopyButton
              [textToCopy]="'https://hdl.handle.net/' + item.objectPid?.substring(4)"></button>
          </div>
        </div>
      </div>
      }

      @if (item.versionPid | empty) {
      <div class="mt-3">

        <h6>{{ 'common.version' | translate }} {{ item.versionNumber }} {{ 'common.handle' | translate }}</h6>
        <div class="row">
          <div class="col text-truncate">
            <a href="https://hdl.handle.net/{{item.versionPid?.substring(4)}}">
              <i class="bi-link"></i>
              {{ item.versionPid }}
            </a>
          </div>
          <div class="col-1 p-0">
            <button class="btn btn-sm border-0 p-0" pureCopyButton
              [textToCopy]="'https://hdl.handle.net/' + item.versionPid?.substring(4)"></button>
          </div>
        </div>

      </div>
      }

      }
    </div>

  </div>
</div>

}
}
@else {
<pure-loading />
}
